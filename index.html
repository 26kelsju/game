<!DOCTYPE html>
<html>
<head>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
</head>
<body>
    <a-scene background="color: #87CEEB" vr-mode-ui="enabled: true">
        <!-- Assets for controller models -->
        <a-assets>
            <a-mixin id="controller-right" 
                     oculus-touch-controls="hand: right" 
                     raycaster="objects: .target, .control, .gameOver"
                     line="color: red; opacity: 0.75">
            </a-mixin>
            <a-mixin id="controller-left" 
                     oculus-touch-controls="hand: left" 
                     raycaster="objects: .target, .control, .gameOver"
                     line="color: blue; opacity: 0.75">
            </a-mixin>
        </a-assets>

        <!-- VR Camera rig -->
        <a-entity id="rig" position="0 1.6 3">
            <!-- Camera with cursor for non-VR mode -->
            <a-camera>
                <a-cursor 
                    position="0 0 -1"
                    geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
                    material="color: white; shader: flat"
                    raycaster="objects: .target, .control, .gameOver">
                </a-cursor>
            </a-camera>
            
            <!-- VR Controllers -->
            <a-entity id="rightController" 
                      mixin="controller-right"
                      oculus-touch-controls="hand: right"
                      raycaster="objects: .target, .control, .gameOver; lineColor: red; lineOpacity: 0.5"
                      line="color: red; opacity: 0.75">
            </a-entity>
            
            <a-entity id="leftController" 
                      mixin="controller-left"
                      oculus-touch-controls="hand: left"
                      raycaster="objects: .target, .control, .gameOver; lineColor: blue; lineOpacity: 0.5"
                      line="color: blue; opacity: 0.75">
            </a-entity>
        </a-entity>
        
        <!-- Ground -->
        <a-plane position="0 0 -4" rotation="-90 0 0" width="20" height="20" color="#4CC3D9"></a-plane>
        
        <!-- Control panel -->
        <a-box id="sizeControl" class="control" position="-3 2 -3" width="1" height="0.5" depth="0.1" color="red">
            <a-text value="SIZE" position="0 0 0.06" align="center" color="white"></a-text>
        </a-box>
        
        <a-box id="speedControl" class="control" position="3 2 -3" width="1" height="0.5" depth="0.1" color="blue">
            <a-text value="SPEED" position="0 0 0.06" align="center" color="white"></a-text>
        </a-box>
        
        <a-box id="shapeControl" class="control" position="0 2 -3" width="1" height="0.5" depth="0.1" color="green">
            <a-text value="SHAPE" position="0 0 0.06" align="center" color="white"></a-text>
        </a-box>
        
        <!-- Score and Timer display -->
        <a-text id="scoreText" position="0 3 -3" value="Score: 0" align="center" color="black"></a-text>
        <a-text id="timerText" position="0 3.5 -3" value="Time: 30" align="center" color="green"></a-text>

        <!-- Game Over Screen (initially hidden) -->
        <a-plane id="gameOverScreen" class="gameOver" position="0 1.5 -2.5" width="6" height="4" color="black" opacity="0.8" visible="false">
            <a-text id="gameOverText" position="0 0.5 0.01" value="GAME OVER!" align="center" color="red"></a-text>
            <a-text id="finalScoreText" position="0 0 0.01" value="Final Score: 0" align="center" color="white"></a-text>
            <a-text id="restartText" position="0 -0.5 0.01" value="Point and click to restart" align="center" color="yellow"></a-text>
        </a-plane>
    </a-scene>

    <script>
        // Game variables
        let score = 0;
        let targetSize = 1;
        let targetSpeed = 2000;
        let gameActive = true;
        let timeLeft = 30;
        let gameTimer;
        let spawnInterval;
        let targetShape = 'cylinder';
        let shapeIndex = 0;
        const shapes = ['cylinder', 'box', 'sphere', 'cone'];
        const shapeColors = ['#ff4444', '#44ff44', '#4444ff', '#ffff44'];

        // Wait for A-frame scene to load
        document.querySelector('a-scene').addEventListener('loaded', function() {
            console.log('Scene loaded, starting game...');
            setupVRControllers();
            startGame();
        });

        function setupVRControllers() {
            // Setup controller event listeners
            const rightController = document.querySelector('#rightController');
            const leftController = document.querySelector('#leftController');
            
            if (rightController) {
                rightController.addEventListener('triggerdown', handleControllerClick);
                rightController.addEventListener('gripdown', handleControllerClick);
            }
            
            if (leftController) {
                leftController.addEventListener('triggerdown', handleControllerClick);
                leftController.addEventListener('gripdown', handleControllerClick);
            }
            
            console.log('VR controllers setup complete');
        }

        function handleControllerClick(event) {
            // Get the intersected element from the raycaster
            const raycaster = event.target.components.raycaster;
            if (raycaster && raycaster.intersectedEls.length > 0) {
                const intersectedEl = raycaster.intersectedEls[0];
                
                // Trigger click event on the intersected element
                intersectedEl.emit('click');
            }
        }

        function startGame() {
            console.log('Starting game...');
            // Reset game state
            score = 0;
            timeLeft = 30;
            gameActive = true;
            
            // Update displays
            updateScore();
            updateTimer();
            
            // Hide game over screen
            document.querySelector('#gameOverScreen').setAttribute('visible', 'false');
            
            // Clear any existing intervals
            if (gameTimer) clearInterval(gameTimer);
            if (spawnInterval) clearInterval(spawnInterval);
            
            // Start game timer (counts down every second)
            gameTimer = setInterval(function() {
                timeLeft--;
                console.log('Time left:', timeLeft);
                updateTimer();
                
                if (timeLeft <= 0) {
                    endGame();
                }
            }, 1000);
            
            // Start spawning targets
            setTimeout(() => {
                spawnTarget();
                spawnInterval = setInterval(spawnTarget, 3000);
            }, 1000);
            
            // Setup controls
            setupControls();
        }

        function updateTimer() {
            const timerText = document.querySelector('#timerText');
            timerText.setAttribute('value', `Time: ${timeLeft}`);
            
            // Change color as time runs out
            if (timeLeft <= 10) {
                timerText.setAttribute('color', 'red');
            } else if (timeLeft <= 20) {
                timerText.setAttribute('color', 'orange');
            } else {
                timerText.setAttribute('color', 'green');
            }
        }

        function updateScore() {
            document.querySelector('#scoreText').setAttribute('value', `Score: ${score}`);
        }

        function endGame() {
            console.log('Game ended!');
            gameActive = false;
            
            // Stop timers
            clearInterval(gameTimer);
            clearInterval(spawnInterval);
            
            // Remove all remaining targets
            const targets = document.querySelectorAll('.target');
            targets.forEach(target => {
                if (target.parentNode) {
                    target.parentNode.removeChild(target);
                }
            });
            
            // Show game over screen
            const gameOverScreen = document.querySelector('#gameOverScreen');
            const finalScoreText = document.querySelector('#finalScoreText');
            
            finalScoreText.setAttribute('value', `Final Score: ${score}`);
            gameOverScreen.setAttribute('visible', 'true');
            
            // Add restart functionality
            gameOverScreen.addEventListener('click', function() {
                startGame();
            });
        }

        function spawnTarget() {
            if (!gameActive) return;
            
            const scene = document.querySelector('a-scene');
            let target;
            
            // Random position
            const x = (Math.random() - 0.5) * 8;
            const startY = -2;
            const z = (Math.random() - 0.5) * 4 - 3;
            
            // Create different shapes based on current setting
            switch(targetShape) {
                case 'cylinder':
                    target = document.createElement('a-cylinder');
                    target.setAttribute('radius', targetSize);
                    target.setAttribute('height', '0.2');
                    break;
                case 'box':
                    target = document.createElement('a-box');
                    target.setAttribute('width', targetSize);
                    target.setAttribute('height', targetSize);
                    target.setAttribute('depth', targetSize);
                    break;
                case 'sphere':
                    target = document.createElement('a-sphere');
                    target.setAttribute('radius', targetSize * 0.7);
                    break;
                case 'cone':
                    target = document.createElement('a-cone');
                    target.setAttribute('radius-bottom', targetSize);
                    target.setAttribute('radius-top', '0');
                    target.setAttribute('height', targetSize * 1.5);
                    break;
            }
            
            // Set common properties
            target.setAttribute('position', `${x} ${startY} ${z}`);
            target.setAttribute('color', shapeColors[shapeIndex]);
            target.setAttribute('class', 'target');
            
            // Add click event for destruction
            target.addEventListener('click', function() {
                if (gameActive) {
                    destroyTarget(target);
                }
            });
            
            scene.appendChild(target);
            
            // Animate target up and down
            animateTarget(target, x, z);
        }

        function animateTarget(target, x, z) {
            // Rise up
            target.setAttribute('animation__up', {
                property: 'position',
                to: `${x} 3 ${z}`,
                dur: targetSpeed,
                easing: 'easeOutQuad'
            });
            
            // Fall down after reaching top
            setTimeout(() => {
                if (target.parentNode && gameActive) {
                    target.setAttribute('animation__down', {
                        property: 'position',
                        to: `${x} -2 ${z}`,
                        dur: targetSpeed,
                        easing: 'easeInQuad'
                    });
                    
                    // Remove target after falling
                    setTimeout(() => {
                        if (target.parentNode) {
                            target.parentNode.removeChild(target);
                        }
                    }, targetSpeed);
                }
            }, targetSpeed);
        }

        function destroyTarget(target) {
            if (!gameActive) return;
            
            // Increase score
            score += 10;
            updateScore();
            
            // Visual destruction effect
            target.setAttribute('animation__destroy', {
                property: 'scale',
                to: '0 0 0',
                dur: 200
            });
            
            // Remove from scene
            setTimeout(() => {
                if (target.parentNode) {
                    target.parentNode.removeChild(target);
                }
            }, 200);
        }

        function setupControls() {
            // Size control
            document.querySelector('#sizeControl').addEventListener('click', function() {
                if (!gameActive) return;
                targetSize = targetSize >= 1.5 ? 0.5 : targetSize + 0.25;
                this.setAttribute('color', targetSize > 1 ? 'darkred' : 'red');
            });
            
            // Speed control
            document.querySelector('#speedControl').addEventListener('click', function() {
                if (!gameActive) return;
                if (targetSpeed > 1000) {
                    targetSpeed -= 500;
                    this.setAttribute('color', 'darkblue');
                } else {
                    targetSpeed = 2500;
                    this.setAttribute('color', 'blue');
                }
            });
            
            // Shape control
            document.querySelector('#shapeControl').addEventListener('click', function() {
                if (!gameActive) return;
                
                // Cycle through shapes
                shapeIndex = (shapeIndex + 1) % shapes.length;
                targetShape = shapes[shapeIndex];
                
                // Update button color to match current shape
                this.setAttribute('color', shapeColors[shapeIndex]);
                
                // Update button text to show current shape
                const shapeText = this.querySelector('a-text');
                shapeText.setAttribute('value', targetShape.toUpperCase());
            });
        }
    </script>
</body>
</html>
